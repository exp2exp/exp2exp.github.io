<html><html><head><meta charset="UTF-8" /><meta content="width=device-width, initial-scale=1.0" name="viewport" /><link href="https://exp2exp.github.io/static/css/firn_base.css" rel="stylesheet" /></head></html><body><main><article class="content"><h1>Experience Report: Steps to "Emacs Hyper Notebooks"</h1><div><div><section></section><div class="firn-headline-section firn-headline-section-1"><h1 class="firn-headline firn-headline-1" id="scenario"><span class="firn-headline-text"><span>Scenario</span></span><span class="firn-org-tags"><span><a class="firn-org-tag" href="/tags#20s">20s</a></span></span></h1><section><p><span>Ray and Cameron have been collaborating for years on theoretical
biology research.  In a typical project, they might use Maxima to make
symbolic calculations and Julia for simulations.</span></p><p><span>Their work combines biology, physics, and computer science.</span></p><ul><li><p><span>E.g., Latest work-in-progress is on branching processes for cancer
  modelling.</span></p></li></ul></section></div><div class="firn-headline-section firn-headline-section-1"><h1 class="firn-headline firn-headline-1" id="the-problem"><span class="firn-headline-text"><span>The problem</span></span><span class="firn-org-tags"><span><a class="firn-org-tag" href="/tags#20s">20s</a></span></span></h1><section><ul><li><p><span>Moving code and data between different programs by hand.</span></p></li><li><p><span>Separate workflows for writing notes and preparing publications.</span></p></li><li><p><span>This is time consuming and error prone!</span></p></li></ul></section></div><div class="firn-headline-section firn-headline-section-1"><h1 class="firn-headline firn-headline-1" id="possible-solutions"><span class="firn-headline-text"><span>Possible solutions</span></span><span class="firn-org-tags"><span><a class="firn-org-tag" href="/tags#20s">20s</a></span></span></h1><section><p><span>Cameron is experienced with Jupyter and...</span></p><ul><li><p><span>we found Script of Scripts (https://vatlab.github.io/sos-docs/)
  but it only solves </span><em><span>some</span></em><span> of the problems.</span></p></li></ul><p><span>Joe and Ray were happy explore Emacs-based solutions.
(And Cameron got enthusiastic about Doom Emacs!)</span></p></section></div><div class="firn-headline-section firn-headline-section-1"><h1 class="firn-headline firn-headline-1" id="emacs+org-mode"><span class="firn-headline-text"><span>Emacs+Org Mode...</span></span><span class="firn-org-tags"><span><a class="firn-org-tag" href="/tags#1m">1m</a></span></span></h1><section><table><tr><td><span>TOOLS</span></td><td><span>EMACS/ORG</span></td><td><span>———————————————————————————————————————</span></td></tr><tr><td><span>Maxima</span></td><td><span>maxima-mode</span></td><td><span>Solving DE symbolically</span></td></tr><tr><td><span>Julia</span></td><td><span>julia-mode</span></td><td><span>Run the numerical solver</span></td></tr><tr><td><span>—</span></td><td><span>org-poly</span></td><td><span>Run multiple modes inside Org mode</span></td></tr><tr><td><span>Beamer</span></td><td><span>org-tree-slide</span></td><td><span>Make slides for a presentation</span></td></tr><tr><td><span>Wikis</span></td><td><span>Org Roam</span></td><td><span>Prepare the paper in a nonlinear wiki</span></td></tr><tr><td><span>—</span></td><td><span>Logseq</span></td><td><span>... with coauthors who don’t use Emacs</span></td></tr><tr><td><span>Pairing</span></td><td><span>lockstep.el</span></td><td><span>Collaborate in real time</span></td></tr><tr><td><span>Etherpad</span></td><td><span>crdt.el</span></td><td><span>... with multiple people typing at once</span></td></tr><tr><td><span>Zotero</span></td><td><span>ORB</span></td><td><span>Reference related work</span></td></tr><tr><td><span>TeX</span></td><td><span>Org Mode!</span></td><td><span>Typeset the results</span></td></tr><tr><td><span>Jekyll</span></td><td><span>Firn</span></td><td><span>Publish work in progress on a blog</span></td></tr><tr><td><span>KaTeX</span></td><td><span>fragtog</span></td><td><span>... including LaTeX math symbols</span></td></tr></table></section></div><div class="firn-headline-section firn-headline-section-1"><h1 class="firn-headline firn-headline-1" id="let’s-try-a-calculation-using-maxima-mode"><span class="firn-headline-text"><span>Let’s try a calculation using Maxima mode</span></span><span class="firn-org-tags"><span><a class="firn-org-tag" href="/tags#1m">1m</a></span></span></h1><section><p><span>  </span><strong><span>Maxima doesn’t have a long-running process by default!</span></strong><span> Here’s a workaround.</span></p><p><span>$${{s\,u_{0}}\over{\left(D\,u_{0}+s\right)\,e^{s\,v}-D\,u_{0}}}$$</span></p><p><span>$${{s\,u_{0}}\over{\left(D\,u_{0}+s\right)\,e^{s\,v}-D\,u_{0}}}$$
$$0$$</span></p></section></div><div class="firn-headline-section firn-headline-section-1"><h1 class="firn-headline firn-headline-1" id="problem-1:-passing-variables-and-outputs!-—-maybe-not-bad?"><span class="firn-headline-text"><span>Problem 1: passing variables and outputs! — maybe not </span><em><span>so</span></em><span> bad?</span></span><span class="firn-org-tags"><span><a class="firn-org-tag" href="/tags#1m">1m</a></span></span></h1><section><p><em><span>Something like this should be enough to stitch Maxima and Julia together.</span></em></p><p><span>                         — </span><a class="firn-external" href="https://kitchingroup.cheme.cmu.edu/blog/2019/02/12/Using-results-from-one-code-block-in-another-org-mode/" target="_blank">Thanks to the Kitchin Group for their docs!</a></p></section></div><div class="firn-headline-section firn-headline-section-1"><h1 class="firn-headline firn-headline-1" id="problem-2:-making-the-process-long-running"><span class="firn-headline-text"><span>Problem 2: Making the process long running</span></span><span class="firn-org-tags"><span><a class="firn-org-tag" href="/tags#3m">3m</a></span></span></h1><div class="firn-headline-section firn-headline-section-2"><h2 class="firn-headline firn-headline-2" id="solution:-access-maxima-via-a-new-“ob-servant”-facility"><span class="firn-headline-text"><span>Solution: access maxima via a new “ob-servant” facility</span></span></h2><section><pre class="language-exp"><code class="language-exp">display2d:false
</code></pre><pre class="language-org"><code class="language-org">false
</code></pre><pre class="language-exp"><code class="language-exp">expand((x+1)^9)
</code></pre><p><span>$$x^9+9\,x^8+36\,x^7+84\,x^6+126\,x^5+126\,x^4+84\,x^3+36\,x^2+9\,x+1$$</span></p><p><span>(</span><strong><span>Bonus feature</span></strong><span>: notice that we made it do tex output by default.)</span></p></section></div><div class="firn-headline-section firn-headline-section-2"><h2 class="firn-headline firn-headline-2" id="minor-change-to-ob-coreel"><span class="firn-headline-text"><span>Minor change to ob-core.el</span></span></h2><section><p><span>We added a </span><code>:servant</code><span> parameter to override </span><code>org-babel-execute:<lang></code><span>
inside </span><code>org-babel-execute-src-block</code><span>.  (We still want to keep the
language around to control fontification etc.)</span></p><pre class="language-diff"><code class="language-diff">715c715,719
< 		 (cmd (intern (concat "org-babel-execute:" lang)))
---
> 		 ;; OVERRIDE WITH :servant TO ACCESS THE PROCESS WE CALL
> 		 ;; e.g. (:servant . "calculator")
> 		 (cmd (if (assoc :servant params)
> 			#'org-babel-servant
> 			(intern (concat "org-babel-execute:" lang))))
</code></pre></section></div><div class="firn-headline-section firn-headline-section-2"><h2 class="firn-headline firn-headline-2" id="quick-overview-of-ob-servantel"><span class="firn-headline-text"><span>Quick overview of ob-servant.el</span></span></h2><section><pre class="language-emacs-lisp"><code class="language-emacs-lisp">(defvar org-babel-servant-info nil)     ;; A hash table storing :preproc, :postproc etc., per service
(defun org-babel-servant-setup () ... )
(defun org-babel-servant-callback (prc str) ... )
(defun org-babel-servant-error-callback (prc str) ... )
(defun org-babel-servant (body params)
      ;; ① Extract the process from the param list.
      ;; ② Preprocess the body if possible.
      ;; ③ Set the timeout.
      ;; ④ Should make sure we really have a process before proceeding further!
      ;; ⑤ Clear the last output.  Later on, we might want to allow the
      ;;    option of archiving the old output for safe keeping. (Like McCarthy Elephant 2000?)
      ;; ⑥ Record the time
      ;; ⑦ Send out a request to the program we’re calling
      ;; ⑧ Wait for the replies... 
      ;; ⑨ Coda for post-processing (when required)
)
</code></pre></section></div><div class="firn-headline-section firn-headline-section-2"><h2 class="firn-headline firn-headline-2" id="example-set-up"><span class="firn-headline-text"><span>Example set up</span></span></h2><section><pre class="language-emacs-lisp"><code class="language-emacs-lisp">(get-buffer-create "maxima-error")
(setq maxima-proc
      (make-process
       :name "maxima-proc"
       :command '("maxima" "--very-quiet") 
       :stderr "maxima-error"
       :filter #'org-babel-servant-callback))

(puthash '("maxima-proc" :preproc) (lambda (x params) (concat "tex(" x ");\n"))  org-babel-servant-info)
(puthash '("maxima-proc" :postproc) (lambda (x params err) (substring x nil -6)) org-babel-servant-info)
(puthash '("maxima-proc" :timeout) 2.0                                           org-babel-servant-info)
</code></pre><p><span>BTW, the </span><em><span>substring</span></em><span> is b/c Maxima prints out </span><code>false</code><span> as a second return here:</span></p><pre class="language-maxima"><code class="language-maxima">tex(expand((x+1)^9));
$$x^9+9\,x^8+36\,x^7+84\,x^6+126\,x^5+126\,x^4+84\,x^3+36\,x^2+9\,x+1$$
false
</code></pre></section></div></div><div class="firn-headline-section firn-headline-section-1"><h1 class="firn-headline firn-headline-1" id="reflections:-pleasure-and-pain!"><span class="firn-headline-text"><span>Reflections: pleasure and pain!</span></span><span class="firn-org-tags"><span><a class="firn-org-tag" href="/tags#30s">30s</a></span></span></h1><section><ol><li><p><span>Getting </span><strong><span>emacs-juypter</span></strong><span> working via TRAMP not resolved (</span><a class="firn-external" href="https://github.com/nnicandro/emacs-jupyter/issues/191" target="_blank">#191</a><span>)!     :-(</span></p></li><li><p><span>Working on ob-servant was pretty fun!                            </span><strong><span>:-)</span></strong></p></li><li><p><span>We got more experience with co-editing code                      </span><strong><span>:-)</span></strong></p></li><li><p><span>The stack is work in progress (e.g. crdt.el bugfixes thanks to
   Qiantan).                                                        </span><strong><span>:-)</span></strong></p></li><li><p><span>A few small </span><strong><span>compatibility issues</span></strong><span> came up with </span><em><span>Firn</span></em><span> and </span><em><span>Logseq</span></em><span>
   (these were addressed by the maintainers quickly!)               </span><strong><span>:-)</span></strong></p></li><li><p><span>We tried getting Emacs running in the browser to make these tools
   widely accessible — but command keys didn’t pass through properly
   on the most popular browsers.                                    :-(</span></p></li><li><p><span>We got benefit from presenting early prototypes at Emacs NYC     </span><strong><span>:-)</span></strong></p></li><li><p><span>Dialogues continue around EmacsConf 2020 w/ Fermin and others    </span><strong><span>:-)</span></strong></p></li></ol></section></div><div class="firn-headline-section firn-headline-section-1"><h1 class="firn-headline firn-headline-1" id="future-work-1"><span class="firn-headline-text"><span>Future work 1</span></span><span class="firn-org-tags"><span><a class="firn-org-tag" href="/tags#30s">30s</a></span></span></h1><section><ul><li><p><span>How to integrate this workflow with Arxana (EmacsConf 2013, FARM 2017)?</span></p><ul><li><p><em><span>One idea</span></em><span>: Arxana deals with transclusions, and could potentially
    help with the combined notes+writeup workflow.</span></p></li><li><p><span>Also relates to the general idea of “network programming”</span></p></li></ul></li><li><p><span>How do we think about “remote control” for long-running processes?</span></p></li></ul></section></div><div class="firn-headline-section firn-headline-section-1"><h1 class="firn-headline firn-headline-1" id="conclusions:-we-have-taken-steps-to-address:"><span class="firn-headline-text"><span>Conclusions: we have taken steps to address:</span></span><span class="firn-org-tags"><span><a class="firn-org-tag" href="/tags#30s">30s</a></span></span></h1><section><p><span>Technical experiments are about </span><em><span>accessing any longrunning process</span></em><span> with
a simple interface.  We’re not the only people to look into
“notebooks” but we think that Emacs has some advantages.</span></p></section><div class="firn-headline-section firn-headline-section-2"><h2 class="firn-headline firn-headline-2" id="reproducible-research"><span class="firn-headline-text"><span>Reproducible research</span></span></h2><section><ul><li><p><span>Something is "reproducible" if it is teachable to someone new!</span></p></li><li><p><span>Org Mode (and literate programming in general) is useful for this.</span></p></li></ul></section></div><div class="firn-headline-section firn-headline-section-2"><h2 class="firn-headline firn-headline-2" id="interdisciplinary-collaboration"><span class="firn-headline-text"><span>Interdisciplinary collaboration</span></span></h2><section><ul><li><p><span>Collaboration across different skill sets is challenging.</span></p></li><li><p><span>Our collaboration was already interdisciplinary...</span></p></li></ul><p><span>• ... but what about collaborations between a scenario planner,
      simulation scientist, and local farmers, etc.?</span></p></section></div></div><div class="firn-headline-section firn-headline-section-1"><h1 class="firn-headline firn-headline-1" id="future-work-2"><span class="firn-headline-text"><span>Future work 2</span></span><span class="firn-org-tags"><span><a class="firn-org-tag" href="/tags#30s">30s</a></span></span></h1><div class="firn-headline-section firn-headline-section-2"><h2 class="firn-headline firn-headline-2" id="science-should-be:"><span class="firn-headline-text"><span>Science should be:</span></span></h2><section><ul><li><p><span>Widely teachable</span></p></li><li><p><span>Sharable</span></p></li><li><p><span>Semi-automated</span></p></li><li><p><span>Transdisciplinary</span></p></li><li><p><span>Real-time, like EmacsConf!</span></p></li></ul></section></div></div></div></div></article></main></body></html>