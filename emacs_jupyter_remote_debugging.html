<html><html><head><meta charset="UTF-8" /><meta content="width=device-width, initial-scale=1.0" name="viewport" /><link href="https://exp2exp.github.io/static/css/firn_base.css" rel="stylesheet" /></head></html><body><main><article class="content"><h1>emacs-jupyter remote debugging</h1><div><div><section></section><div class="firn-headline-section firn-headline-section-1"><h1 class="firn-headline firn-headline-1" id="set-up-container-on-gcp"><span class="firn-headline-text"><span>Set up container on gcp</span></span></h1><div class="firn-headline-section firn-headline-section-2"><h2 class="firn-headline firn-headline-2" id="gcp-configuration"><span class="firn-headline-text"><span>gcp configuration</span></span></h2><section><p><span>You may like to run </span><code>gcloud auth login</code><span> ( </span><a class="firn-external" href="https://cloud.google.com/sdk/gcloud/reference/auth/login" target="_blank">auth login docs</a><span> ). This is an interactive process that launches oauth for your google account in the web browser so I think it is best to do it from a terminal though it may be possible to run it in org-babel.</span></p><pre><code>gcloud config configurations list
</code></pre><pre><code>gcloud config configurations describe quarere
</code></pre></section></div><div class="firn-headline-section firn-headline-section-2"><h2 class="firn-headline firn-headline-2" id="launch-container-image"><span class="firn-headline-text"><span>launch container image</span></span></h2><section><p><span>Deploy a vm based on the container </span><code>cameronraysmith/notebooks:latest</code><span>.</span></p><pre><code>gcloud compute instances create-with-container notebooks-vm \
    --container-image registry.hub.docker.com/cameronraysmith/notebooks:latest \
    --container-restart-policy on-failure \
    --container-privileged \
    --container-stdin \
    --container-tty \
    --container-mount-host-path mount-path=/home/jupyter,host-path=/tmp,mode=rw \
    --machine-type n1-standard-1 \
    --boot-disk-size 50GB \
    --preemptible
</code></pre><p><span>Setup ssh with your new instance</span></p><pre><code>gcloud compute config-ssh
cat ~/.ssh/config | grep "Host notebooks"
</code></pre><p><span>You can </span><code>ssh</code><span> into the host machine or the container using the various commands below.</span></p><p><span>Of course you can stop and start the machine with</span></p></section></div></div><div class="firn-headline-section firn-headline-section-1"><h1 class="firn-headline firn-headline-1" id="startup-the-cloud-vm-running-our-container-of-interest"><span class="firn-headline-text"><span>Startup the cloud vm running our container of interest</span></span></h1><div class="firn-headline-section firn-headline-section-2"><h2 class="firn-headline firn-headline-2" id="setup-remote-container-host-machine"><span class="firn-headline-text"><span>Setup remote container host machine</span></span></h2><section><p><span>We already setup the container named </span><code>notebooks-vm</code><span> so all we need to do to begin with is to start it up.</span></p><pre><code>gcloud compute instances start notebooks-vm
</code></pre><p><span>Check that our instance is indeed running</span></p><pre><code>gcloud compute instances list
</code></pre><p><span>Make sure the correct ip address is entered into our </span><code>.ssh/config</code><span> file.</span></p><pre><code>gcloud compute config-ssh
</code></pre><p><span>Inspect the IP address we find in our </span><code>.ssh/config</code><span> file</span></p><pre><code>grep HostName ~/.ssh/config
</code></pre></section><div class="firn-headline-section firn-headline-section-3"><h3 class="firn-headline firn-headline-3" id="execute-commands-on-the-remote-container-host-machine"><span class="firn-headline-text"><span>Execute commands on the remote container host machine</span></span></h3><section><pre><code>hostname --long
</code></pre><pre><code>docker container ls
</code></pre><pre><code>docker container ls
</code></pre></section></div></div></div><div class="firn-headline-section firn-headline-section-1"><h1 class="firn-headline firn-headline-1" id="run-shell-commands-on-the-remote-container"><span class="firn-headline-text"><span>Run shell commands on the remote container</span></span></h1><section><p><span>To switch between two available configurations, choose one of the lines below to copy to the </span><code>:PROPERTIES:</code><span> drawer for this section.</span></p><p><span>In order to connect to the remote host followed by the docker container we specify the directory as </span><code>ssh:notebooks-vm</code><span> (including the extra details we got from </span><code>gcloud compute ssh-config</code><span>) followed by </span><code>docker:containername</code><span> where we got the container name from running </span><code>docker container ls</code><span> on the remote machine.</span></p><pre><code>echo $JUPYTER_PATH
</code></pre><pre><code>head -3 /proc/self/cgroup
</code></pre><p><span>Check the working directory and the list of jupyter kernels</span></p><pre><code>echo $JUPYTER_PATH
</code></pre><pre><code>jupyter kernelspec list
</code></pre><p><span>If you try to make use of an existing session on the docker container to run one of the </span><code>emacs-jupyter</code><span> kernels, you find that there is a different usage of the TRAMP remote path specification in the </span><code>:dir</code><span> property for the </span><code>sh</code><span> language of babel and with the </span><code>:session</code><span> property in the </span><code>emacs-jupyter</code><span> </span><em><span>language</span></em><span> of babel. This is the error I got the first time I tried this with the TRAMP remote path specification in </span><code>:dir</code><span>:</span></p></section><div class="firn-headline-section firn-headline-section-2"><h2 class="firn-headline firn-headline-2" id="run-python-session-on-the-remote-container"><span class="firn-headline-text"><span>Run python session on the remote container</span></span></h2><section><p><span>The default properties that should apply to this section are</span></p><p><span>In order to connect to the remote host followed by the docker container we specify the directory as </span><code>ssh:notebooks-vm</code><span> (including the extra details we got from </span><code>gcloud compute ssh-config</code><span>) followed by a </span><code>|</code><span> and then </span><code>docker:containername</code><span> where we got the container name from running </span><code>docker container ls</code><span> on the remote machine.</span></p><pre><code>x = 'foo'
y = 'bar'
print(x + ' ' + y)
</code></pre><pre><code>x = 1 + 1
print(x)
</code></pre></section></div></div><div class="firn-headline-section firn-headline-section-1"><h1 class="firn-headline firn-headline-1" id="bug:-run-a-jupyter-kernel-in-a-remote-container"><span class="firn-headline-text"><span>BUG: Run a jupyter kernel in a remote container</span></span></h1><div class="firn-headline-section firn-headline-section-2"><h2 class="firn-headline firn-headline-2" id="properties"><span class="firn-headline-text"><span>properties</span></span></h2><section><p><span>To switch between two available configurations, choose one of the lines below to copy to the </span><code>:PROPERTIES:</code><span> drawer for this section.</span></p></section></div><div class="firn-headline-section firn-headline-section-2"><h2 class="firn-headline firn-headline-2" id="test-code"><span class="firn-headline-text"><span>test code</span></span></h2><section><pre><code>x = 'foo'
y = 'bar'
x + ' ' + y
</code></pre><p><span>There is a problem whereby the </span><code>:dir</code><span> property is being passed along to jupyter as if it were a file. It looks like the intention may be to pass the TRAMP parameters to </span><code>:session</code><span> rather than </span><code>:dir</code><span> in the case of </span><code>emacs-jupyter</code><span>.</span></p><p><span>Here there is a bug that has been reported in </span><a class="firn-external" href="https://github.com/nnicandro/emacs-jupyter/issues/191" target="_blank">issue 191 of emacs-jupyter</a><span>.</span></p><p><span>There is a </span><a class="firn-external" href="https://github.com/nnicandro/emacs-jupyter/issues/72#issuecomment-543952258" target="_blank">suggestion from arthurcgusmao</a><span> in another issue stating one needs to set the </span><code>JUPYTER_PATH</code><span> environment variable to resolve the </span><code>Kernel did not respond to kernel-info request</code><span> issue.</span></p><p><span>It is simple to set the </span><code>JUPYTER_PATH</code><span> environment variable via tramp</span></p><p><span>however, this does not resolve the issue.</span></p><p><span>I originally tried to set the environment variable by passing a parameter to docker, but this did not work properly in the sense that if you check the value from inside the container it does not appear to be set despite what appears to be the appropriate docker flag for doing so.</span></p></section></div><div class="firn-headline-section firn-headline-section-2"><h2 class="firn-headline firn-headline-2" id="debugging-jupyter-kernel-info"><span class="firn-headline-text"><span>Debugging </span><code>jupyter-kernel-info</code></span></h2><section><p><code>jupyter-kernel-info</code><span> is the function from which the error </span><code>Kernel did not respond to kernel-info request</code><span> arises (see </span><a class="firn-external" href="https://github.com/nnicandro/emacs-jupyter/blob/403c70c83cb3754c83da0932b0efaf5e72bdca9a/jupyter-client.el#L2066" target="_blank">line 2066 of jupyter-client.el</a><span>).</span></p><p><span>The stack trace for </span><code>jupyter-kernel-info</code></p><p><span>Printing the value of the </span><code>client</code><span> variable from inside </span><code>edebug</code><span> on </span><code>jupyter-kernel-info</code><span> yields</span></p><p><span>When I check all of the existing kernel files, I find one whose kernel ID is different ( </span><code>14238987-f1b4-4049-982a-94012ddb7087</code><span> )from what is contained in the </span><code>client</code><span> variable ( </span><code>38bcac68-f74f-4bd2-b1e7-998df7c14c4f</code><span> ), but whose key and various ports are all correct.</span></p><p><span>This suggests that the root of the problem is that the kernel ID is not being captured accurately. There is no kernel with an ID equivalent to the one that appears in the </span><code>client</code><span> variable, so it is not clear to me where the value that appears in the client variable is coming from. I don't know if there is any condition in which jupyter changes the kernel ID and leaves all other parameters the same.</span></p><p><span>The issue appears to arise in </span><code>jupyter-make-client</code><span> (see </span><a class="firn-external" href="https://github.com/nnicandro/emacs-jupyter/blob/a9ae0bcef52a62cf7df520756d994162a0570156/jupyter-kernel-manager.el#L141" target="_blank">L141 in jupyter-kernel-manager.el</a><span>) when calling </span><code>make-instance class</code><span> for class </span><code>jupyter-org-client</code><span> which derives from </span><code>jupyter-repl-client</code><span> which derives from </span><code>jupyter-kernel-client</code><span>. The </span><code>session</code><span> is defined as an element of </span><code>jupyter-kernel-client</code><span> at </span><a class="firn-external" href="https://github.com/nnicandro/emacs-jupyter/blob/403c70c83cb3754c83da0932b0efaf5e72bdca9a/jupyter-client.el#L215" target="_blank">L215 of jupyter-client.el</a><span>.</span></p></section></div></div></div></div><div><hr /><div class="backlinks"><h4>Backlinks to this document:</h4><ul class="firn-backlinks"><li class="firn-backlink"><a href="https://exp2exp.github.io/20200905125342-emacs_hyper_notebook">Emacs Hyper Notebook</a></li></ul></div></div></article></main></body></html>